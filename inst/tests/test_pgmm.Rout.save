
R version 4.4.2 (2024-10-31 ucrt) -- "Pile of Leaves"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: x86_64-w64-mingw32/x64

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> library("plm")
> data("EmplUK", package = "plm")
> 
> # Arellano/Bond 1991, Table 4, column (a1) (has robust SEs)
> ab.a1 <- pgmm(log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 0:1)
+               + lag(log(capital), 0:2) + lag(log(output), 0:2) | lag(log(emp), 2:99),
+               data = EmplUK, effect = "twoways", model = "onestep")
> 
> (s.ab.a1  <- summary(ab.a1, robust = FALSE)) # xtabond manual, example 1, has slightly different values for non-robust standard errors
Twoways effects One-step model Difference GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + lag(log(capital), 0:2) + lag(log(output), 0:2) | lag(log(emp), 
    2:99), data = EmplUK, effect = "twoways", model = "onestep")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 611
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.6006508 -0.0299498  0.0000000 -0.0001193  0.0311461  0.5693264 

Coefficients:
                         Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1      0.686226   0.143272  4.7897 1.671e-06 ***
lag(log(emp), 1:2)2     -0.085358   0.042839 -1.9925 0.0463110 *  
lag(log(wage), 0:1)0    -0.607821   0.063404 -9.5864 < 2.2e-16 ***
lag(log(wage), 0:1)1     0.392623   0.105309  3.7283 0.0001928 ***
lag(log(capital), 0:2)0  0.356846   0.035700  9.9957 < 2.2e-16 ***
lag(log(capital), 0:2)1 -0.058001   0.056209 -1.0319 0.3021238    
lag(log(capital), 0:2)2 -0.019948   0.040131 -0.4971 0.6191424    
lag(log(output), 0:2)0   0.608506   0.129703  4.6915 2.712e-06 ***
lag(log(output), 0:2)1  -0.711164   0.177827 -3.9992 6.356e-05 ***
lag(log(output), 0:2)2   0.105798   0.137720  0.7682 0.4423635    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(25) = 48.74983 (p-value = 0.0030295)
Autocorrelation test (1): normal = -4.190586 (p-value = 2.7824e-05)
Autocorrelation test (2): normal = -0.6424125 (p-value = 0.52061)
Wald test for coefficients: chisq(10) = 547.9814 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(6) = 10.26874 (p-value = 0.11378)
> (s.ab.a1r <- summary(ab.a1, robust = TRUE)) # as tabulated by Arellano/Bond
Twoways effects One-step model Difference GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + lag(log(capital), 0:2) + lag(log(output), 0:2) | lag(log(emp), 
    2:99), data = EmplUK, effect = "twoways", model = "onestep")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 611
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.6006508 -0.0299498  0.0000000 -0.0001193  0.0311461  0.5693264 

Coefficients:
                         Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1      0.686226   0.144594  4.7459 2.076e-06 ***
lag(log(emp), 1:2)2     -0.085358   0.056016 -1.5238 0.1275510    
lag(log(wage), 0:1)0    -0.607821   0.178205 -3.4108 0.0006478 ***
lag(log(wage), 0:1)1     0.392623   0.167993  2.3371 0.0194319 *  
lag(log(capital), 0:2)0  0.356846   0.059020  6.0462 1.483e-09 ***
lag(log(capital), 0:2)1 -0.058001   0.073180 -0.7926 0.4280206    
lag(log(capital), 0:2)2 -0.019948   0.032713 -0.6098 0.5420065    
lag(log(output), 0:2)0   0.608506   0.172531  3.5269 0.0004204 ***
lag(log(output), 0:2)1  -0.711164   0.231716 -3.0691 0.0021469 ** 
lag(log(output), 0:2)2   0.105798   0.141202  0.7493 0.4536974    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(25) = 48.74983 (p-value = 0.0030295)
Autocorrelation test (1): normal = -3.599593 (p-value = 0.00031872)
Autocorrelation test (2): normal = -0.5160282 (p-value = 0.60583)
Wald test for coefficients: chisq(10) = 408.2859 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(6) = 11.57904 (p-value = 0.072046)
> 
> ### Arellano-Bond test, Sargan test and Wald test yield different results for onestep
> ## xtabond2 result for robust mtest for col. a1
> #  xtabond2 n L.n L2.n w L.w L(0/2).(k ys) yr*, gmm(L.n) iv(w L.w L(0/2).(k ys) yr*) nolevel robust
> #Arellano-Bond test for AR(1) in first differences: z = -3.60 Pr > z = 0.000
> #Arellano-Bond test for AR(2) in first differences: z = -0.52 Pr > z = 0.606
> 
> 
> # Arellano/Bond 1991, Table 4, column (a2) (non-robust SEs)
> ab.a2 <- pgmm(log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 0:1)
+               + lag(log(capital), 0:2) + lag(log(output), 0:2) | lag(log(emp), 2:99),
+               data = EmplUK, effect = "twoways", model = "twosteps")
> (s.ab.a2  <- summary(ab.a2, robust = FALSE)) # as tabulated by Arellano/Bond
Twoways effects Two-steps model Difference GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + lag(log(capital), 0:2) + lag(log(output), 0:2) | lag(log(emp), 
    2:99), data = EmplUK, effect = "twoways", model = "twosteps")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 611
Residuals:
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-0.687507 -0.029383  0.000000 -0.000311  0.030857  0.633822 

Coefficients:
                         Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1      0.628709   0.090454  6.9506 3.638e-12 ***
lag(log(emp), 1:2)2     -0.065188   0.026501 -2.4598  0.013900 *  
lag(log(wage), 0:1)0    -0.525760   0.053769 -9.7781 < 2.2e-16 ***
lag(log(wage), 0:1)1     0.311290   0.094012  3.3112  0.000929 ***
lag(log(capital), 0:2)0  0.278362   0.044908  6.1984 5.702e-10 ***
lag(log(capital), 0:2)1  0.014100   0.052805  0.2670  0.789459    
lag(log(capital), 0:2)2 -0.040248   0.025804 -1.5598  0.118809    
lag(log(output), 0:2)0   0.591923   0.116211  5.0935 3.515e-07 ***
lag(log(output), 0:2)1  -0.565985   0.139674 -4.0522 5.074e-05 ***
lag(log(output), 0:2)2   0.100543   0.112675  0.8923  0.372217    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(25) = 31.38142 (p-value = 0.1767)
Autocorrelation test (1): normal = -2.99977 (p-value = 0.0027018)
Autocorrelation test (2): normal = -0.4157541 (p-value = 0.67759)
Wald test for coefficients: chisq(10) = 667.0498 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(6) = 24.93988 (p-value = 0.00035032)
> (s.ab.a2r <- summary(ab.a2, robust = TRUE))
Twoways effects Two-steps model Difference GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + lag(log(capital), 0:2) + lag(log(output), 0:2) | lag(log(emp), 
    2:99), data = EmplUK, effect = "twoways", model = "twosteps")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 611
Residuals:
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-0.687507 -0.029383  0.000000 -0.000311  0.030857  0.633822 

Coefficients:
                         Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1      0.628709   0.193413  3.2506 0.0011516 ** 
lag(log(emp), 1:2)2     -0.065188   0.045050 -1.4470 0.1478934    
lag(log(wage), 0:1)0    -0.525760   0.154610 -3.4005 0.0006725 ***
lag(log(wage), 0:1)1     0.311290   0.203000  1.5334 0.1251663    
lag(log(capital), 0:2)0  0.278362   0.072802  3.8235 0.0001315 ***
lag(log(capital), 0:2)1  0.014100   0.092458  0.1525 0.8787948    
lag(log(capital), 0:2)2 -0.040248   0.043274 -0.9301 0.3523329    
lag(log(output), 0:2)0   0.591923   0.173091  3.4197 0.0006269 ***
lag(log(output), 0:2)1  -0.565985   0.261100 -2.1677 0.0301820 *  
lag(log(output), 0:2)2   0.100543   0.161098  0.6241 0.5325571    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(25) = 31.38142 (p-value = 0.1767)
Autocorrelation test (1): normal = -2.125472 (p-value = 0.033547)
Autocorrelation test (2): normal = -0.3516578 (p-value = 0.72509)
Wald test for coefficients: chisq(10) = 269.1608 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(6) = 15.43165 (p-value = 0.017152)
> 
> ## Arellano and Bond (1991), table 4 col. b / Windmeijer (2025), table 2
> ab.b <- pgmm(log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 0:1)
+            + log(capital) + lag(log(output), 0:1) | lag(log(emp), 2:99),
+             data = EmplUK, effect = "twoways", model = "twosteps")
> (s.ab.b  <- summary(ab.b, robust = FALSE)) # as tabulated by Arellano/Bond
Twoways effects Two-steps model Difference GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + log(capital) + lag(log(output), 0:1) | lag(log(emp), 
    2:99), data = EmplUK, effect = "twoways", model = "twosteps")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 611
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.6190677 -0.0255683  0.0000000 -0.0001339  0.0332013  0.6410272 

Coefficients:
                        Estimate Std. Error  z-value  Pr(>|z|)    
lag(log(emp), 1:2)1     0.474151   0.085303   5.5584 2.722e-08 ***
lag(log(emp), 1:2)2    -0.052967   0.027284  -1.9413 0.0522200 .  
lag(log(wage), 0:1)0   -0.513205   0.049345 -10.4003 < 2.2e-16 ***
lag(log(wage), 0:1)1    0.224640   0.080063   2.8058 0.0050192 ** 
log(capital)            0.292723   0.039463   7.4177 1.191e-13 ***
lag(log(output), 0:1)0  0.609775   0.108524   5.6188 1.923e-08 ***
lag(log(output), 0:1)1 -0.446373   0.124815  -3.5763 0.0003485 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(25) = 30.11247 (p-value = 0.22011)
Autocorrelation test (1): normal = -2.427829 (p-value = 0.01519)
Autocorrelation test (2): normal = -0.3325401 (p-value = 0.73948)
Wald test for coefficients: chisq(7) = 371.9877 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(6) = 26.9045 (p-value = 0.0001509)
> (s.ab.br <- summary(ab.b, robust = TRUE))  # Windmeijer (2025), table 2, twostep, std. errc
Twoways effects Two-steps model Difference GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + log(capital) + lag(log(output), 0:1) | lag(log(emp), 
    2:99), data = EmplUK, effect = "twoways", model = "twosteps")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 611
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.6190677 -0.0255683  0.0000000 -0.0001339  0.0332013  0.6410272 

Coefficients:
                        Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1     0.474151   0.185398  2.5575 0.0105437 *  
lag(log(emp), 1:2)2    -0.052967   0.051749 -1.0235 0.3060506    
lag(log(wage), 0:1)0   -0.513205   0.145565 -3.5256 0.0004225 ***
lag(log(wage), 0:1)1    0.224640   0.141950  1.5825 0.1135279    
log(capital)            0.292723   0.062627  4.6741 2.953e-06 ***
lag(log(output), 0:1)0  0.609775   0.156263  3.9022 9.530e-05 ***
lag(log(output), 0:1)1 -0.446373   0.217302 -2.0542 0.0399605 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(25) = 30.11247 (p-value = 0.22011)
Autocorrelation test (1): normal = -1.53845 (p-value = 0.12394)
Autocorrelation test (2): normal = -0.2796829 (p-value = 0.77972)
Wald test for coefficients: chisq(7) = 142.0353 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(6) = 16.97046 (p-value = 0.0093924)
> 
> # Windmeijer (2025), table 2, onestep with corrected std. err
> # (Windmeijer's table header does not indicate that for one-step model these are
> # corrected std errors, but this can be varified when looking at the produced results)
> wind.s1 <- pgmm(log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 0:1)
+              + log(capital) + lag(log(output), 0:1) | lag(log(emp), 2:99),
+              data = EmplUK, effect = "twoways", model = "onestep")
> (s.wind.s1 <- summary(wind.s1, robust = TRUE))
Twoways effects One-step model Difference GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + log(capital) + lag(log(output), 0:1) | lag(log(emp), 
    2:99), data = EmplUK, effect = "twoways", model = "onestep")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 611
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.5911117 -0.0262899  0.0000000 -0.0000754  0.0340327  0.5811418 

Coefficients:
                        Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1     0.534614   0.166449  3.2119 0.0013187 ** 
lag(log(emp), 1:2)2    -0.075069   0.067979 -1.1043 0.2694623    
lag(log(wage), 0:1)0   -0.591573   0.167884 -3.5237 0.0004256 ***
lag(log(wage), 0:1)1    0.291510   0.141058  2.0666 0.0387722 *  
log(capital)            0.358502   0.053828  6.6601 2.736e-11 ***
lag(log(output), 0:1)0  0.597198   0.171933  3.4734 0.0005138 ***
lag(log(output), 0:1)1 -0.611704   0.211796 -2.8882 0.0038748 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(25) = 44.61875 (p-value = 0.009239)
Autocorrelation test (1): normal = -2.493372 (p-value = 0.012654)
Autocorrelation test (2): normal = -0.3594476 (p-value = 0.71926)
Wald test for coefficients: chisq(7) = 219.6233 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(6) = 11.45041 (p-value = 0.075414)
> 
> 
> ab.b.collapse <- pgmm(log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 0:1)
+            + log(capital) + lag(log(output), 0:1) | lag(log(emp), 2:99),
+            data = EmplUK, effect = "twoways", model = "twosteps", collapse = TRUE)
> summary(ab.b.collapse, robust = TRUE) # default
Twoways effects Two-steps model Difference GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + log(capital) + lag(log(output), 0:1) | lag(log(emp), 
    2:99), data = EmplUK, effect = "twoways", model = "twosteps", 
    collapse = TRUE)

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 611
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.8455637 -0.0326605  0.0000000 -0.0003799  0.0312841  0.7010278 

Coefficients:
                        Estimate Std. Error z-value Pr(>|z|)   
lag(log(emp), 1:2)1     0.853895   0.562348  1.5184 0.128902   
lag(log(emp), 1:2)2    -0.169886   0.123293 -1.3779 0.168232   
lag(log(wage), 0:1)0   -0.533119   0.245948 -2.1676 0.030189 * 
lag(log(wage), 0:1)1    0.352516   0.432846  0.8144 0.415408   
log(capital)            0.271707   0.089921  3.0216 0.002514 **
lag(log(output), 0:1)0  0.612855   0.242289  2.5294 0.011424 * 
lag(log(output), 0:1)1 -0.682550   0.612311 -1.1147 0.264974   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(5) = 11.62681 (p-value = 0.040275)
Autocorrelation test (1): normal = -1.290551 (p-value = 0.19686)
Autocorrelation test (2): normal = 0.4482577 (p-value = 0.65397)
Wald test for coefficients: chisq(7) = 134.788 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(6) = 11.91947 (p-value = 0.06379)
> 
> ab.b.ind <- pgmm(log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 0:1)
+            + log(capital) + lag(log(output), 0:1) | lag(log(emp), 2:99),
+             data = EmplUK, effect = "individual", model = "twosteps")
> summary(ab.b.ind, robust = TRUE) # default
Oneway (individual) effect Two-steps model Difference GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + log(capital) + lag(log(output), 0:1) | lag(log(emp), 
    2:99), data = EmplUK, effect = "individual", model = "twosteps")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 611
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.5891371 -0.0258848  0.0000000 -0.0001108  0.0354295  0.6092587 

Coefficients:
                        Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1     0.448806   0.182638  2.4573 0.0139968 *  
lag(log(emp), 1:2)2    -0.042209   0.056360 -0.7489 0.4539021    
lag(log(wage), 0:1)0   -0.542931   0.150326 -3.6117 0.0003042 ***
lag(log(wage), 0:1)1    0.191413   0.154501  1.2389 0.2153787    
log(capital)            0.320322   0.057396  5.5809 2.393e-08 ***
lag(log(output), 0:1)0  0.636832   0.113729  5.5996 2.149e-08 ***
lag(log(output), 0:1)1 -0.246296   0.204975 -1.2016 0.2295240    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(25) = 31.87899 (p-value = 0.16154)
Autocorrelation test (1): normal = -1.501206 (p-value = 0.1333)
Autocorrelation test (2): normal = -0.41767 (p-value = 0.67619)
Wald test for coefficients: chisq(7) = 725.4739 (p-value = < 2.22e-16)
> 
> 
> ## Blundell and Bond (1998) table 4 (cf. DPD for OX p.12 col.4)
> ## not quite...
> ## Maybe due to this: "The original implementation of system GMM
> ## (Blundell and Bond 1998) used H = I." (from Roodman 2009, p. 117)
> z2 <- pgmm(log(emp) ~ lag(log(emp), 1)+ lag(log(wage), 0:1) +
+            lag(log(capital), 0:1) | lag(log(emp), 2:99) +
+            lag(log(wage), 3:99) + lag(log(capital), 2:99),
+            data = EmplUK, effect = "twoways", model = "onestep", 
+            transformation = "ld")
> summary(z2, robust = TRUE)
Twoways effects One-step model System GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1) + lag(log(wage), 0:1) + 
    lag(log(capital), 0:1) | lag(log(emp), 2:99) + lag(log(wage), 
    3:99) + lag(log(capital), 2:99), data = EmplUK, effect = "twoways", 
    model = "onestep", transformation = "ld")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 1642
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.7501512 -0.0389075  0.0000000  0.0001834  0.0459166  0.6149616 

Coefficients:
                         Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1)         0.945068   0.029312 32.2415 < 2.2e-16 ***
lag(log(wage), 0:1)0    -0.655654   0.105377 -6.2220 4.909e-10 ***
lag(log(wage), 0:1)1     0.499634   0.128513  3.8878 0.0001012 ***
lag(log(capital), 0:1)0  0.474032   0.054796  8.6509 < 2.2e-16 ***
lag(log(capital), 0:1)1 -0.414113   0.061467 -6.7371 1.616e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(94) = 115.8547 (p-value = 0.062687)
Autocorrelation test (1): normal = -4.955307 (p-value = 7.2216e-07)
Autocorrelation test (2): normal = -0.2551838 (p-value = 0.79858)
Wald test for coefficients: chisq(5) = 7517.379 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(7) = 15.88489 (p-value = 0.026189)
> 
> z2b <- pgmm(log(emp) ~ lag(log(emp), 1)+ lag(log(wage), 0:1) +
+            lag(log(capital), 0:1) | lag(log(emp), 2:99) +
+            lag(log(wage), 3:99) + lag(log(capital), 2:99),
+            data = EmplUK, effect = "individual", model = "onestep", 
+            transformation = "ld")
> summary(z2b, robust = TRUE)
Oneway (individual) effect One-step model System GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1) + lag(log(wage), 0:1) + 
    lag(log(capital), 0:1) | lag(log(emp), 2:99) + lag(log(wage), 
    3:99) + lag(log(capital), 2:99), data = EmplUK, effect = "individual", 
    model = "onestep", transformation = "ld")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 1642
Residuals:
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-0.772126 -0.035115  0.000000  0.004193  0.055023  0.591462 

Coefficients:
                         Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1)         0.903871   0.045345 19.9333 < 2.2e-16 ***
lag(log(wage), 0:1)0    -0.513039   0.088364 -5.8059 6.400e-09 ***
lag(log(wage), 0:1)1     0.546466   0.089703  6.0919 1.116e-09 ***
lag(log(capital), 0:1)0  0.554952   0.048778 11.3771 < 2.2e-16 ***
lag(log(capital), 0:1)1 -0.484148   0.050905 -9.5108 < 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(94) = 104.872 (p-value = 0.20826)
Autocorrelation test (1): normal = -5.646905 (p-value = 1.6336e-08)
Autocorrelation test (2): normal = -0.5507488 (p-value = 0.58181)
Wald test for coefficients: chisq(5) = 20061.48 (p-value = < 2.22e-16)
> 
> 
> z3 <- pgmm(log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 0:1)
+            + log(capital) + lag(log(output), 0:1) | lag(log(emp), 2:99),
+            data = EmplUK, effect = "twoways", model = "twosteps", transformation = "ld")
> summary(z3)
Twoways effects Two-steps model System GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + log(capital) + lag(log(output), 0:1) | lag(log(emp), 
    2:99), data = EmplUK, effect = "twoways", model = "twosteps", 
    transformation = "ld")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 1362
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-1.2783232 -0.0312663  0.0000000 -0.0008859  0.0305511  0.9968286 

Coefficients:
                        Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1     1.159729   0.065914 17.5945 < 2.2e-16 ***
lag(log(emp), 1:2)2    -0.208429   0.052465 -3.9727 7.105e-05 ***
lag(log(wage), 0:1)0   -0.384443   0.200473 -1.9177  0.055152 .  
lag(log(wage), 0:1)1    0.345628   0.207797  1.6633  0.096254 .  
log(capital)            0.043447   0.024748  1.7555  0.079166 .  
lag(log(output), 0:1)0  0.551373   0.212272  2.5975  0.009391 ** 
lag(log(output), 0:1)1 -0.549793   0.214530 -2.5628  0.010384 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(37) = 57.1014 (p-value = 0.018479)
Autocorrelation test (1): normal = -2.035183 (p-value = 0.041832)
Autocorrelation test (2): normal = 0.06457302 (p-value = 0.94851)
Wald test for coefficients: chisq(7) = 50169.13 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(6) = 20.07568 (p-value = 0.0026848)
> 
> z3col <- pgmm(log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 0:1)
+               + log(capital) + lag(log(output), 0:1) | lag(log(emp), 2:99),
+               data = EmplUK, effect = "twoways", model = "twosteps", collapse = TRUE, transformation = "ld")
> summary(z3col)
Twoways effects Two-steps model System GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + log(capital) + lag(log(output), 0:1) | lag(log(emp), 
    2:99), data = EmplUK, effect = "twoways", model = "twosteps", 
    collapse = TRUE, transformation = "ld")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 1362
Residuals:
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-1.607481 -0.026549  0.000000  0.001298  0.032377  1.235349 

Coefficients:
                        Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1     1.229634   0.079161 15.5334 < 2.2e-16 ***
lag(log(emp), 1:2)2    -0.263162   0.061139 -4.3043 1.675e-05 ***
lag(log(wage), 0:1)0   -0.219949   0.133473 -1.6479   0.09938 .  
lag(log(wage), 0:1)1    0.179443   0.136161  1.3179   0.18755    
log(capital)            0.032176   0.026294  1.2237   0.22107    
lag(log(output), 0:1)0  0.438920   0.199552  2.1995   0.02784 *  
lag(log(output), 0:1)1 -0.463668   0.203810 -2.2750   0.02291 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(11) = 19.53659 (p-value = 0.052116)
Autocorrelation test (1): normal = -1.590997 (p-value = 0.11161)
Autocorrelation test (2): normal = 0.3393808 (p-value = 0.73432)
Wald test for coefficients: chisq(7) = 73202.37 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(6) = 28.81019 (p-value = 6.608e-05)
> 
> 
> z3ind <- pgmm(log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 0:1)
+               + log(capital) + lag(log(output), 0:1) | lag(log(emp), 2:99),
+               data = EmplUK, effect = "individual", model = "twosteps", transformation = "ld")
> summary(z3ind)
Oneway (individual) effect Two-steps model System GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + log(capital) + lag(log(output), 0:1) | lag(log(emp), 
    2:99), data = EmplUK, effect = "individual", model = "twosteps", 
    transformation = "ld")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 1362
Residuals:
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-1.11438 -0.03413  0.00000 -0.00239  0.03146  0.91822 

Coefficients:
                        Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1     1.169008   0.082802 14.1180 < 2.2e-16 ***
lag(log(emp), 1:2)2    -0.226597   0.062002 -3.6546 0.0002575 ***
lag(log(wage), 0:1)0   -0.483095   0.180535 -2.6759 0.0074528 ** 
lag(log(wage), 0:1)1    0.429235   0.198680  2.1604 0.0307393 *  
log(capital)            0.054308   0.032483  1.6719 0.0945465 .  
lag(log(output), 0:1)0  0.647134   0.124038  5.2172 1.816e-07 ***
lag(log(output), 0:1)1 -0.595851   0.138535 -4.3011 1.700e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(37) = 66.41158 (p-value = 0.0021142)
Autocorrelation test (1): normal = -2.431116 (p-value = 0.015052)
Autocorrelation test (2): normal = -0.02784006 (p-value = 0.97779)
Wald test for coefficients: chisq(7) = 77862.01 (p-value = < 2.22e-16)
> 
> z3indcol <- pgmm(log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 0:1)
+                  + log(capital) + lag(log(output), 0:1) | lag(log(emp), 2:99),
+                  data = EmplUK, effect = "individual", model = "twosteps", transformation = "ld")
> summary(z3indcol)
Oneway (individual) effect Two-steps model System GMM 

Call:
pgmm(formula = log(emp) ~ lag(log(emp), 1:2) + lag(log(wage), 
    0:1) + log(capital) + lag(log(output), 0:1) | lag(log(emp), 
    2:99), data = EmplUK, effect = "individual", model = "twosteps", 
    transformation = "ld")

Unbalanced Panel: n = 140, T = 7-9, N = 1031

Number of Observations Used: 1362
Residuals:
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-1.11438 -0.03413  0.00000 -0.00239  0.03146  0.91822 

Coefficients:
                        Estimate Std. Error z-value  Pr(>|z|)    
lag(log(emp), 1:2)1     1.169008   0.082802 14.1180 < 2.2e-16 ***
lag(log(emp), 1:2)2    -0.226597   0.062002 -3.6546 0.0002575 ***
lag(log(wage), 0:1)0   -0.483095   0.180535 -2.6759 0.0074528 ** 
lag(log(wage), 0:1)1    0.429235   0.198680  2.1604 0.0307393 *  
log(capital)            0.054308   0.032483  1.6719 0.0945465 .  
lag(log(output), 0:1)0  0.647134   0.124038  5.2172 1.816e-07 ***
lag(log(output), 0:1)1 -0.595851   0.138535 -4.3011 1.700e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(37) = 66.41158 (p-value = 0.0021142)
Autocorrelation test (1): normal = -2.431116 (p-value = 0.015052)
Autocorrelation test (2): normal = -0.02784006 (p-value = 0.97779)
Wald test for coefficients: chisq(7) = 77862.01 (p-value = < 2.22e-16)
> 
> 
> 
> # Baltagi (2005, 2013/2021), Table 8.1
> # Interesting note: Baltagi (2005, 3rd), table 8.1 has different values compared 
> # to Baltagi (2013/2021, 5th/6th) for the two-step GMM case where the difference 
> # stems from using xtabond2 and collapsed instruments in the newer editions 
> # (as opposed to xtabond and not mentioning of collapsed instruments in older edition).
> 
> data("Cigar", package = "plm")
> Cigar$real_c     <- Cigar$sales * Cigar$pop / Cigar$pop16
> Cigar$real_p     <- Cigar$price / Cigar$cpi * 100
> Cigar$real_pimin <- Cigar$pimin / Cigar$cpi * 100
> Cigar$real_ndi   <- Cigar$ndi   / Cigar$cpi
> Cigar$log_real_c     <- log(Cigar$real_c)
> Cigar$log_real_p     <- log(Cigar$real_p)
> Cigar$log_real_pimin <- log(Cigar$real_pimin)
> Cigar$log_real_ndi   <- log(Cigar$real_ndi)
> 
> year.d <- contr.treatment(levels(factor(Cigar$year)))
> year.d <- cbind("63" = c(1, rep(0, nrow(year.d)-1)), year.d) # add base level
> colnames(year.d) <- paste0("year", colnames(year.d)) # make colnames
> year.d <- cbind("year" = rownames(year.d), as.data.frame(year.d)) # add column with year as numeric (to enable merge in next step) and make final data frame
> 
> Cigar <- merge(Cigar, year.d, by = "year", sort = FALSE, all.x = TRUE, all.y = FALSE)
> Cigar <- Cigar[ , c(2,1, 3:length(names(Cigar)))] # order columns
> pCigar <- pdata.frame(Cigar, index = c("state", "year"))
> 
> # Baltagi (2005, 3rd edition), table 8.1 [one-step not contained in later editions anymore]
> # GMM-one-step
> form_cig_GMMonestep_tw <- formula(log(real_c) ~ lag(log(real_c)) + log(real_p) + log(real_pimin) + log(real_ndi) 
+                                | lag(log(real_c), 2:99)
+                                | log(real_p) + log(real_pimin) + log(real_ndi) )
> 
> gmm_onestep_tw <- pgmm(form_cig_GMMonestep_tw, data = Cigar, effect = "twoways", model = "onestep")
Warning message:
In pgmm(form_cig_GMMonestep_tw, data = Cigar, effect = "twoways",  :
  the second-step matrix is singular, a general inverse is used
> (sgmm_onestep_tw <- summary(gmm_onestep_tw, robust = TRUE))
Twoways effects One-step model Difference GMM 

Call:
pgmm(formula = form_cig_GMMonestep_tw, data = Cigar, effect = "twoways", 
    model = "onestep")

Balanced Panel: n = 46, T = 30, N = 1380

Number of Observations Used: 1288
Residuals:
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-0.309407 -0.022219 -0.001561  0.000000  0.022143  0.293543 

Coefficients:
                  Estimate Std. Error z-value Pr(>|z|)    
lag(log(real_c))  0.842867   0.031279 26.9466  < 2e-16 ***
log(real_p)      -0.377229   0.045527 -8.2859  < 2e-16 ***
log(real_pimin)  -0.016150   0.059643 -0.2708  0.78657    
log(real_ndi)     0.139449   0.064857  2.1501  0.03155 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(405) = 46 (p-value = 1)
Autocorrelation test (1): normal = -5.071433 (p-value = 3.9483e-07)
Autocorrelation test (2): normal = 2.281198 (p-value = 0.022537)
Wald test for coefficients: chisq(4) = 1440.769 (p-value = < 2.22e-16)
Wald test for time dummies: chisq(28) = 1252.564 (p-value = < 2.22e-16)
Warning message:
In vcovHC.pgmm(object) : a general inverse is used
> round(sgmm_onestep_tw$coefficients[ , 1], 3)
lag(log(real_c))      log(real_p)  log(real_pimin)    log(real_ndi) 
           0.843           -0.377           -0.016            0.139 
> round(sgmm_onestep_tw$coefficients[ , 3], 3) 
lag(log(real_c))      log(real_p)  log(real_pimin)    log(real_ndi) 
          26.947           -8.286           -0.271            2.150 
> 
> # matches coefficients in table 8.1:    0.84, -0.377, -0.016, 0.14
> # but not t-statistics in parenthesis:  (52.0) (11.7) ( 0.4)  (3.8)
> #
> # Keane/Neal (2016). p. 529 replicate by (small diff in statistics vs. Baltagi)
> # xtabond2 logc l.logc logp logpn logy i.yr, gmm(l.logc) iv(logp logpn logy i.yr) nolevel
> # What they call DIFF-GMM is “GMM-one-step” in Baltagi (2005)
> # and give 3 digits of coefficients:
> #                                   0.843  −0.377  −0.016 0.139
> #                                   (52.66)  (−11.81)  (−0.39) (3.88)
> 
> # individual onestep without time dummies:
> # Keane/Neal (2016). p. 529 also give individual model (without time dummies) by
> # xtabond2 logc l.logc logp logpn logy, gmm(l.logc) iv(logp logpn logy) nolevel
> # 0.891  −0.152  0.050  −0.071
> # (47.04) (−5.49) (1.85) (−6.09)
> form_cig_GMMonestep_ind <- formula(log(real_c) ~ lag(log(real_c)) + log(real_p) + log(real_pimin) + log(real_ndi)
+                                    | lag(log(real_c), 2:99))
> gmm_onestep_ind <- pgmm(form_cig_GMMonestep_ind, data = pCigar, effect = "individual", model = "onestep")
Warning message:
In pgmm(form_cig_GMMonestep_ind, data = pCigar, effect = "individual",  :
  the second-step matrix is singular, a general inverse is used
> (sgmm_onestep_ind <- summary(gmm_onestep_ind, robust = TRUE))
Oneway (individual) effect One-step model Difference GMM 

Call:
pgmm(formula = form_cig_GMMonestep_ind, data = pCigar, effect = "individual", 
    model = "onestep")

Balanced Panel: n = 46, T = 30, N = 1380

Number of Observations Used: 1288
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.3233858 -0.0267407 -0.0008852  0.0018121  0.0285814  0.3085815 

Coefficients:
                  Estimate Std. Error z-value  Pr(>|z|)    
lag(log(real_c))  0.891281   0.019606 45.4603 < 2.2e-16 ***
log(real_p)      -0.151918   0.036855 -4.1221 3.755e-05 ***
log(real_pimin)   0.050345   0.034864  1.4441    0.1487    
log(real_ndi)    -0.070571   0.013654 -5.1686 2.359e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(405) = 46 (p-value = 1)
Autocorrelation test (1): normal = -5.327237 (p-value = 9.9718e-08)
Autocorrelation test (2): normal = 2.216107 (p-value = 0.026684)
Wald test for coefficients: chisq(4) = 9571.196 (p-value = < 2.22e-16)
Warning message:
In vcovHC.pgmm(object) : a general inverse is used
> round(sgmm_onestep_ind$coefficients[ , 1], 3)
lag(log(real_c))      log(real_p)  log(real_pimin)    log(real_ndi) 
           0.891           -0.152            0.050           -0.071 
> round(sgmm_onestep_ind$coefficients[ , 3], 3)
lag(log(real_c))      log(real_p)  log(real_pimin)    log(real_ndi) 
          45.460           -4.122            1.444           -5.169 
> ## -> matches coefficients, but not statistics
> 
> # Replicate OLS and 2-way FE from Baltagi table 8.1
> form_cig_OLS <- log(real_c) ~ lag(log(real_c)) + log(real_p) + log(real_pimin) + log(real_ndi)
> summary(plm(form_cig_OLS, data= Cigar, model="pooling"))
Pooling Model

Call:
plm(formula = form_cig_OLS, data = Cigar, model = "pooling")

Balanced Panel: n = 46, T = 29, N = 1334

Residuals:
      Min.    1st Qu.     Median    3rd Qu.       Max. 
-0.2042970 -0.0205536  0.0012857  0.0236424  0.2239515 

Coefficients:
                   Estimate Std. Error  t-value  Pr(>|t|)    
(Intercept)       0.5827881  0.0623703   9.3440 < 2.2e-16 ***
lag(log(real_c))  0.9694942  0.0061489 157.6687 < 2.2e-16 ***
log(real_p)      -0.0901512  0.0145795  -6.1834 8.332e-10 ***
log(real_pimin)   0.0240347  0.0131562   1.8269   0.06794 .  
log(real_ndi)    -0.0306788  0.0060279  -5.0895 4.106e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    66.746
Residual Sum of Squares: 2.3538
R-Squared:      0.96474
Adj. R-Squared: 0.96463
F-statistic: 9089.46 on 4 and 1329 DF, p-value: < 2.22e-16
> summary(plm(form_cig_OLS, data= Cigar, model="within", effect = "twoways"))
Twoways effects Within Model

Call:
plm(formula = form_cig_OLS, data = Cigar, effect = "twoways", 
    model = "within")

Balanced Panel: n = 46, T = 29, N = 1334

Residuals:
      Min.    1st Qu.     Median    3rd Qu.       Max. 
-0.1843242 -0.0168631  0.0013432  0.0173047  0.2582479 

Coefficients:
                  Estimate Std. Error  t-value  Pr(>|t|)    
lag(log(real_c))  0.833383   0.012562  66.3438 < 2.2e-16 ***
log(real_p)      -0.298598   0.023601 -12.6519 < 2.2e-16 ***
log(real_pimin)   0.034045   0.027465   1.2396    0.2154    
log(real_ndi)     0.100279   0.023850   4.2046 2.801e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    11.449
Residual Sum of Squares: 1.647
R-Squared:      0.85614
Adj. R-Squared: 0.84733
F-statistic: 1868.75 on 4 and 1256 DF, p-value: < 2.22e-16
> 
> 
> # two-step GMM
> #
> ## Table 8.1, 8.2 in Baltagi (2021): Coefs (z-stat) 0.70 (10.2) −0.396 (6.0) −0.105 (1.3) 0.13 (3.5) 
> # 
> # Stata xtabond2 lnc L.(lnc) lnrp lnrpn lnrdi dum3 dum8 dum10-dum29, gmm(L.(lnc), collapse)
> #           iv(lnrp lnrpn lndrdi dum3 dum8 dum10-29) noleveleq robust nomata twostep
> # No of obs 1288, no of groups = 46, balanced, 28 obs/group, no of instruments = 53
> 
> 
> # not quite (need to add IV instruments!?):
> form2021 <- formula(log(real_c) ~ lag(log(real_c)) + log(real_p) + log(real_pimin) + log(real_ndi) +
+   # year63 + year64 +
+   year65 + 
+   # year66 + year67 + year68 + year69 + 
+   year70 + 
+   # year71 + 
+   year72 + year73 + year74 + year75 + year76 + year77 + 
+   year78 + year79 + year80 + year81 + year82 + year83 + 
+   year84 + year85 + year86 + year87 + year88 + year89 + 
+   year90 + year91
+ #  + year92
+  | lag(log(real_c), 2:99) | log(real_p) + log(real_pimin) + log(real_ndi)
+ )
> 
> gmm_twostep <- pgmm(form2021, data = pCigar, effect = "individual", model = "twosteps", transformation = "d", collapse = TRUE)
> summary(gmm_twostep)
Oneway (individual) effect Two-steps model Difference GMM 

Call:
pgmm(formula = form2021, data = pCigar, effect = "individual", 
    model = "twosteps", collapse = TRUE, transformation = "d")

Balanced Panel: n = 46, T = 30, N = 1380

Number of Observations Used: 1288
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.2923112 -0.0238082 -0.0004016 -0.0001540  0.0218978  0.2798715 

Coefficients:
                   Estimate Std. Error z-value  Pr(>|z|)    
lag(log(real_c))  0.7669130  0.0737487 10.3990 < 2.2e-16 ***
log(real_p)      -0.3525282  0.0552063 -6.3856 1.707e-10 ***
log(real_pimin)  -0.0946344  0.0727694 -1.3005 0.1934401    
log(real_ndi)     0.1535458  0.0421783  3.6404 0.0002722 ***
year65            0.0213381  0.0062009  3.4411 0.0005793 ***
year70           -0.0377538  0.0090047 -4.1927 2.757e-05 ***
year72            0.0166913  0.0093099  1.7929 0.0729953 .  
year73           -0.0291286  0.0096845 -3.0078 0.0026318 ** 
year74           -0.0470458  0.0111596 -4.2157 2.490e-05 ***
year75           -0.0661374  0.0138919 -4.7609 1.928e-06 ***
year76           -0.0488896  0.0121037 -4.0392 5.362e-05 ***
year77           -0.0861520  0.0146308 -5.8884 3.900e-09 ***
year78           -0.0705559  0.0139390 -5.0617 4.154e-07 ***
year79           -0.1161043  0.0159697 -7.2703 3.587e-13 ***
year80           -0.1324310  0.0201140 -6.5840 4.579e-11 ***
year81           -0.1422395  0.0231258 -6.1507 7.715e-10 ***
year82           -0.1418028  0.0192502 -7.3663 1.754e-13 ***
year83           -0.1211889  0.0128217 -9.4519 < 2.2e-16 ***
year84           -0.1049203  0.0110053 -9.5336 < 2.2e-16 ***
year85           -0.0716692  0.0094304 -7.5998 2.966e-14 ***
year86           -0.0710242  0.0099860 -7.1124 1.141e-12 ***
year87           -0.0689422  0.0076442 -9.0189 < 2.2e-16 ***
year88           -0.0767389  0.0125003 -6.1390 8.306e-10 ***
year89           -0.0713561  0.0078829 -9.0520 < 2.2e-16 ***
year90           -0.0633409  0.0094709 -6.6879 2.263e-11 ***
year91           -0.0536709  0.0099893 -5.3729 7.750e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(5) = 11.07974 (p-value = 0.049822)
Autocorrelation test (1): normal = -4.627692 (p-value = 3.6976e-06)
Autocorrelation test (2): normal = 1.889075 (p-value = 0.058882)
Wald test for coefficients: chisq(26) = 4305.55 (p-value = < 2.22e-16)
> 
> 
> ## Table 8.1, 8.2 in Baltagi (2005) "GMM-two-step"
> # Coefs (z-stat) 0.80 (3.7) −0.379 (8.0) −0.020 (0.4) 0.24 (0.9)
> # with xtbond (not xtbond2) and a different set of time dummies:
> # xtabond lnc lnrp lnrpn lnrdi dum3-dum29, lag(1) twostep
> form2005 <- formula(log(real_c) ~ lag(log(real_c)) + log(real_p) + log(real_pimin) + log(real_ndi) +
+ # + year63 + year64 
+   year65 + 
+   year66 + year67 + year68 + year69 + 
+   year70 + 
+   year71 + 
+   year72 + year73 + year74 + year75 + year76 + year77 + 
+   year78 + year79 + year80 + year81 + year82 + year83 + 
+   year84 + year85 + year86 + year87 + year88 + year89 + 
+   year90 + year91
+  # year92 
+   | lag(log(real_c), 2:99))
> 
> gmm_twostep_2005 <- pgmm(form2005, data = pCigar, effect = "individual", model = "twosteps", transformation = "d")
Warning message:
In pgmm(form2005, data = pCigar, effect = "individual", model = "twosteps",  :
  the second-step matrix is singular, a general inverse is used
> summary(gmm_twostep_2005)
Oneway (individual) effect Two-steps model Difference GMM 

Call:
pgmm(formula = form2005, data = pCigar, effect = "individual", 
    model = "twosteps", transformation = "d")

Balanced Panel: n = 46, T = 30, N = 1380

Number of Observations Used: 1288
Residuals:
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.3155528 -0.0223345 -0.0009081 -0.0002982  0.0206165  0.2960017 

Coefficients:
                   Estimate Std. Error z-value  Pr(>|z|)    
lag(log(real_c))  0.7991766  0.1962817  4.0716 4.670e-05 ***
log(real_p)      -0.3696419  0.0921545 -4.0111 6.043e-05 ***
log(real_pimin)  -0.0782846  0.1524425 -0.5135  0.607577    
log(real_ndi)     0.1846966  0.1215665  1.5193  0.128686    
year65            0.0243308  0.0094619  2.5715  0.010127 *  
year66           -0.0030911  0.0118500 -0.2609  0.794207    
year67            0.0131757  0.0137773  0.9563  0.338905    
year68           -0.0017510  0.0144538 -0.1211  0.903575    
year69           -0.0111711  0.0138267 -0.8079  0.419126    
year70           -0.0383205  0.0190457 -2.0120  0.044217 *  
year71            0.0064850  0.0134505  0.4821  0.629709    
year72            0.0115149  0.0223779  0.5146  0.606857    
year73           -0.0320925  0.0331616 -0.9678  0.333165    
year74           -0.0422986  0.0377234 -1.1213  0.262167    
year75           -0.0653186  0.0408507 -1.5990  0.109829    
year76           -0.0521701  0.0395207 -1.3201  0.186812    
year77           -0.0833946  0.0466671 -1.7870  0.073936 .  
year78           -0.0777370  0.0457138 -1.7005  0.089034 .  
year79           -0.1228220  0.0499804 -2.4574  0.013995 *  
year80           -0.1270269  0.0556802 -2.2814  0.022527 *  
year81           -0.1484367  0.0615838 -2.4103  0.015939 *  
year82           -0.1467949  0.0540749 -2.7147  0.006634 ** 
year83           -0.1216310  0.0418559 -2.9059  0.003661 ** 
year84           -0.1055779  0.0350749 -3.0101  0.002612 ** 
year85           -0.0751966  0.0299454 -2.5111  0.012035 *  
year86           -0.0711153  0.0278238 -2.5559  0.010591 *  
year87           -0.0712981  0.0237736 -2.9990  0.002708 ** 
year88           -0.0738314  0.0274059 -2.6940  0.007060 ** 
year89           -0.0714217  0.0182389 -3.9159 9.007e-05 ***
year90           -0.0632753  0.0154565 -4.0938 4.244e-05 ***
year91           -0.0487161  0.0162177 -3.0039  0.002666 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Sargan test: chisq(405) = 21.91377 (p-value = 1)
Autocorrelation test (1): normal = -3.804323 (p-value = 0.00014219)
Autocorrelation test (2): normal = 1.899814 (p-value = 0.057458)
Wald test for coefficients: chisq(31) = 11112.15 (p-value = < 2.22e-16)
Warning message:
In vcovHC.pgmm(object) : a general inverse is used
> round(coefficients(gmm_twostep_2005)[1:4], 3)
lag(log(real_c))      log(real_p)  log(real_pimin)    log(real_ndi) 
           0.799           -0.370           -0.078            0.185 
> ## -> only nearly replicates
> 
> pdynmc.avail <- if (!requireNamespace("pdynmc", quietly = TRUE)) FALSE else TRUE
> 
> if(pdynmc.avail) {
+   
+   library(pdynmc)
+   ## from PDF R-Journal (https://journal.r-project.org/archive/2021/RJ-2021-035/RJ-2021-035.pdf)
+   dat <- EmplUK
+   dat[ , c(4:7)] <- log(dat[ , c(4:7)])
+   names(dat)[4:7] <- c("n", "w", "k", "ys") # n = emp, w = wage, k = capital, ys = output
+   
+   ### Sargan test and Wald test yield a different results for onestep
+   ab.a1.pdynmc <- pdynmc(
+     dat = dat, varname.i = "firm", varname.t = "year",
+     use.mc.diff = TRUE, use.mc.lev = FALSE, use.mc.nonlin = FALSE,
+     include.y = TRUE, varname.y = "n", lagTerms.y = 2,
+     fur.con = TRUE, fur.con.diff = TRUE, fur.con.lev = FALSE,
+     varname.reg.fur = c("w", "k", "ys"), lagTerms.reg.fur = c(1,2,2),
+     include.dum = TRUE, dum.diff = TRUE, dum.lev = FALSE, varname.dum = "year",
+     w.mat = "iid.err", std.err = "unadjusted",
+     estimation = "onestep", opt.meth = "none")
+   summary(ab.a1.pdynmc)
+   
+   ab.a1r.pdynmc <- pdynmc(
+     dat = dat, varname.i = "firm", varname.t = "year",
+     use.mc.diff = TRUE, use.mc.lev = FALSE, use.mc.nonlin = FALSE,
+     include.y = TRUE, varname.y = "n", lagTerms.y = 2,
+     fur.con = TRUE, fur.con.diff = TRUE, fur.con.lev = FALSE,
+     varname.reg.fur = c("w", "k", "ys"), lagTerms.reg.fur = c(1,2,2),
+     include.dum = TRUE, dum.diff = TRUE, dum.lev = FALSE, varname.dum = "year",
+     w.mat = "iid.err", std.err = "corrected",
+     estimation = "onestep", opt.meth = "none")
+   summary(ab.a1r.pdynmc)
+   
+   ab.a2.pdynmc <- pdynmc(
+     dat = dat, varname.i = "firm", varname.t = "year",
+     use.mc.diff = TRUE, use.mc.lev = FALSE, use.mc.nonlin = FALSE,
+     include.y = TRUE, varname.y = "n", lagTerms.y = 2,
+     fur.con = TRUE, fur.con.diff = TRUE, fur.con.lev = FALSE,
+     varname.reg.fur = c("w", "k", "ys"), lagTerms.reg.fur = c(1,2,2),
+     include.dum = TRUE, dum.diff = TRUE, dum.lev = FALSE, varname.dum = "year",
+     w.mat = "iid.err", std.err = "unadjusted",
+     estimation = "twostep", opt.meth = "none")
+   summary(ab.a2.pdynmc)
+   
+   ab.a2r.pdynmc <- pdynmc(
+     dat = dat, varname.i = "firm", varname.t = "year",
+     use.mc.diff = TRUE, use.mc.lev = FALSE, use.mc.nonlin = FALSE,
+     include.y = TRUE, varname.y = "n", lagTerms.y = 2,
+     fur.con = TRUE, fur.con.diff = TRUE, fur.con.lev = FALSE,
+     varname.reg.fur = c("w", "k", "ys"), lagTerms.reg.fur = c(1,2,2),
+     include.dum = TRUE, dum.diff = TRUE, dum.lev = FALSE, varname.dum = "year",
+     w.mat = "iid.err", std.err = "corrected",
+     estimation = "twostep", opt.meth = "none")
+   summary(ab.a2r.pdynmc)
+   
+   
+   ab.b.pdynmc <- pdynmc(
+     dat = dat, varname.i = "firm", varname.t = "year",
+     use.mc.diff = TRUE, use.mc.lev = FALSE, use.mc.nonlin = FALSE,
+     include.y = TRUE, varname.y = "n", lagTerms.y = 2,
+     fur.con = TRUE, fur.con.diff = TRUE, fur.con.lev = FALSE,
+     varname.reg.fur = c("w", "k", "ys"), lagTerms.reg.fur = c(1,0,1),
+     include.dum = TRUE, dum.diff = TRUE, dum.lev = FALSE, varname.dum = "year",
+     w.mat = "iid.err", std.err = "unadjusted",
+     estimation = "twostep", opt.meth = "none")
+   summary(ab.b.pdynmc)
+   
+   ab.br.pdynmc <- pdynmc(
+     dat = dat, varname.i = "firm", varname.t = "year",
+     use.mc.diff = TRUE, use.mc.lev = FALSE, use.mc.nonlin = FALSE,
+     include.y = TRUE, varname.y = "n", lagTerms.y = 2,
+     fur.con = TRUE, fur.con.diff = TRUE, fur.con.lev = FALSE,
+     varname.reg.fur = c("w", "k", "ys"), lagTerms.reg.fur = c(1,0,1),
+     include.dum = TRUE, dum.diff = TRUE, dum.lev = FALSE, varname.dum = "year",
+     w.mat = "iid.err", std.err = "corrected",
+     estimation = "twostep", opt.meth = "none")
+   summary(ab.br.pdynmc)
+   
+   ### check coefs and SE pgmm vs. pdynmc ###
+   
+   ## one-step GMM
+   # check coefficients
+   stopifnot(isTRUE(all.equal(round( s.ab.a1[[1L]][ , 1], 5), round( ab.a1.pdynmc$coefficients[1:10], 5), check.attributes = FALSE)))
+   
+   # check standard errors (non-robust and robust) 
+     # pdynmc 2025-01-05 does not seem to produce correct non-robust SEs in one-step case
+ #  stopifnot(isTRUE(all.equal(round( s.ab.a1[[1L]][ , 2], 5), round( ab.a1.pdynmc$stderr$step1[1:10], 5), check.attributes = FALSE)))
+   stopifnot(isTRUE(all.equal(round(s.ab.a1r[[1L]][ , 2], 5), round(ab.a1r.pdynmc$stderr$step1[1:10], 5), check.attributes = FALSE)))
+   
+   ## two-steps GMM
+   # check coefficients
+   stopifnot(isTRUE(all.equal(round( s.ab.a2[[1L]][ , 1], 5), round( ab.a2.pdynmc$coefficients[1:10], 5), check.attributes = FALSE)))
+   
+   # check standard errors (non-robust and robust)
+   stopifnot(isTRUE(all.equal(round( s.ab.a2[[1L]][ , 2], 5), round( ab.a2.pdynmc$stderr$step2[1:10], 5), check.attributes = FALSE)))
+   stopifnot(isTRUE(all.equal(round(s.ab.a2r[[1L]][ , 2], 5), round(ab.a2r.pdynmc$stderr$step2[1:10], 5), check.attributes = FALSE)))
+   
+   # check coefficients
+   stopifnot(isTRUE(all.equal(round( s.ab.b[[1L]][ , 1], 5), round( ab.b.pdynmc$coefficients[1:7], 5), check.attributes = FALSE)))
+   
+   # check standard errors (non-robust and robust)
+   stopifnot(isTRUE(all.equal(round( s.ab.b[[1L]][ , 2], 5), round( ab.b.pdynmc$stderr$step2[1:7], 5), check.attributes = FALSE)))
+   stopifnot(isTRUE(all.equal(round(s.ab.br[[1L]][ , 2], 5), round(ab.br.pdynmc$stderr$step2[1:7], 5), check.attributes = FALSE)))
+   
+   
+   ## Baltagi table 8.1
+   
+   ## TODO: does not replicate literature yet
+   c1 <- pdynmc(dat = Cigar, varname.i = "state", varname.t = "year",
+                use.mc.diff = TRUE, use.mc.lev = FALSE, use.mc.nonlin = FALSE,
+                include.y = TRUE, varname.y = "real_c", lagTerms.y = 1,
+                fur.con = TRUE, fur.con.diff = TRUE, fur.con.lev = FALSE,
+                varname.reg.fur = c("real_p", "real_pimin", "real_ndi",
+                                    # "year65", "year70", paste0("year", 72:91)), # Baltagi 2013, 2021
+                                    paste0("year", 65:91)),  # Baltagi 2005
+                lagTerms.reg.fur = c(rep(0, 3), rep(0, 27)), # Baltagi 2005
+                include.dum = FALSE,
+                inst.collapse = FALSE,
+                w.mat = "iid.err", std.err = "corrected", estimation = "twostep",
+                opt.meth = "none")
+   summary(c1)
+   
+   # onestep without time dummies
+   onestep_ind <- pdynmc(dat = Cigar, varname.i = "state", varname.t = "year",
+                         use.mc.diff = TRUE, use.mc.lev = FALSE, use.mc.nonlin = FALSE,
+                         include.y = TRUE, varname.y = "log_real_c", lagTerms.y = 1,
+                         fur.con = TRUE, fur.con.diff = TRUE, fur.con.lev = FALSE,
+                         varname.reg.fur = c("log_real_p", "log_real_pimin", "log_real_ndi"),
+                         lagTerms.reg.fur = c(rep(0, 3)),
+                         include.dum = FALSE,
+                         inst.collapse = FALSE,
+                         w.mat = "iid.err", std.err = "corrected", estimation = "onestep",
+                         opt.meth = "none")
+   summary(onestep_ind)
+ }

Dynamic linear panel estimation (onestep)
GMM estimation steps: 1

Coefficients:
                  Estimate Std.Err.rob z-value.rob Pr(>|z.rob|)    
L1.log_real_c      0.87686     0.02701      32.463       <2e-16 ***
L0.log_real_p     -0.14801     0.03734      -3.963        7e-05 ***
L0.log_real_pimin  0.04069     0.04020       1.012        0.312    
L0.log_real_ndi   -0.07858     0.01540      -5.103       <2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

 409 total instruments are employed to estimate 4 parameters
 406 linear (DIF) 
 3 further controls (DIF) 
 no time dummies 
 
J-Test (overid restrictions):  54.08 with 405 DF, pvalue: 1
F-Statistic (slope coeff):  1401.93 with 4 DF, pvalue: <0.001
F-Statistic (time dummies):  no time dummies included in estimation
> 
> proc.time()
   user  system elapsed 
  45.53    4.20   49.65 
